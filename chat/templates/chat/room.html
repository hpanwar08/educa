{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}
  Chat Room for {{ course.title }}
{% endblock %}

{% block content %}
  <div>
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title text-secondary text-center mb-3">Room {{ course.title }}</h4>
          <hr>

          <div class="row">
            <div id="chat" class="mb-3 overflow-auto vh-50" ></div>
          </div>

          <div id="chat-input">

            <div class="row">
              <div class="col-md-10">
                <input type="text" class="form-control" id="chat-message-input" placeholder="Type message">
              </div>
              <div class="col-md-2">
                <button class="btn btn-info text-white" id="chat-message-submit">Send</button>
              </div>
            </div>

          </div>

        </div>

      </div>
    </div>
  </div>
{% endblock %}

{% block domready %}
  const url = 'ws://' + window.location.host + '/ws/chat/room/' + '{{ course.id }}/';
  const chatSocket = new WebSocket(url);

  chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      const message = data.message;
      const $chat = $('#chat');
      $chat.append('<div class="w-75 mb-3"><div class="d-inline-flex p-2 text-break bg-light ">' + message + '</div></div><br>');
      $chat.scrollTop($chat[0].scrollHeight);

  };

  chatSocket.onclose = function (e) {
      console.log('Chat socket closed unexpectedly')
  };

  const $input = $('#chat-message-input');
  const $submit = $('#chat-message-submit');

  $submit.click(function () {
      const message = $input.val();
      if (message) {
          chatSocket.send(JSON.stringify({'message': message}));
          $input.val('');
          $input.focus();
      }
  });

  $input.focus();
  $input.keyup(function (e){
      if(e.keyCode === 13){
          $submit.click()
      }
  });
{% endblock %}
